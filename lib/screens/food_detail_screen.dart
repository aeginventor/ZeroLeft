import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../models/food_item.dart';
import '../providers/food_provider.dart';
import '../utils/constants.dart';
import '../utils/date_utils.dart' as app_date_utils;
import '../widgets/remaining_days_badge.dart';
import 'add_food_screen.dart';

/// ÏãùÌíà ÏÉÅÏÑ∏ ÌôîÎ©¥
class FoodDetailScreen extends StatelessWidget {
  final FoodItem food;

  const FoodDetailScreen({
    super.key,
    required this.food,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(food.name),
        actions: [
          // ÏàòÏ†ï Î≤ÑÌäº
          IconButton(
            icon: const Icon(Icons.edit),
            onPressed: () async {
              final result = await Navigator.push<bool>(
                context,
                MaterialPageRoute(
                  builder: (context) => AddFoodScreen(foodToEdit: food),
                ),
              );
              
              if (result == true && context.mounted) {
                // ÏàòÏ†ï ÌõÑ ÏÉÅÏÑ∏ ÌôîÎ©¥ Îã´Í∏∞
                Navigator.pop(context, true);
              }
            },
            tooltip: 'ÏàòÏ†ï',
          ),
          
          // ÏÇ≠Ï†ú Î≤ÑÌäº
          IconButton(
            icon: const Icon(Icons.delete),
            onPressed: () => _showDeleteDialog(context),
            tooltip: 'ÏÇ≠Ï†ú',
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(AppConstants.defaultPadding),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // ÎÇ®ÏùÄ Í∏∞Ìïú ÎåÄÌòï Î±ÉÏßÄ
            if (!food.isConsumed) ...[
              LargeRemainingDaysBadge(remainingDays: food.remainingDays),
              const SizedBox(height: 24),
            ],
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÏΩò (ÌÅ∞ ÌÅ¨Í∏∞)
            if (food.category != null) ...[
              Center(
                child: Container(
                  width: 120,
                  height: 120,
                  decoration: BoxDecoration(
                    color: AppConstants.freshGreen.withValues(alpha: 0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Center(
                    child: Text(
                      FoodCategories.icons[food.category] ?? 'üì¶',
                      style: const TextStyle(fontSize: 64),
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              Center(
                child: Text(
                  food.category!,
                  style: Theme.of(context).textTheme.titleLarge?.copyWith(
                        color: AppConstants.freshGreen,
                        fontWeight: FontWeight.bold,
                      ),
                ),
              ),
              const SizedBox(height: 32),
            ],
            
            // Ï†ïÎ≥¥ Ïπ¥Îìú
            _buildInfoCard(
              context,
              title: 'ÏãùÌíà Ï†ïÎ≥¥',
              icon: Icons.info_outline,
              children: [
                _buildInfoRow(
                  context,
                  icon: Icons.label,
                  label: 'Ïù¥Î¶Ñ',
                  value: food.name,
                ),
                if (food.category != null)
                  _buildInfoRow(
                    context,
                    icon: Icons.category,
                    label: 'Ïπ¥ÌÖåÍ≥†Î¶¨',
                    value: food.category!,
                  ),
              ],
            ),
            
            const SizedBox(height: 16),
            
            // ÎÇ†Ïßú Ï†ïÎ≥¥ Ïπ¥Îìú
            _buildInfoCard(
              context,
              title: 'ÎÇ†Ïßú Ï†ïÎ≥¥',
              icon: Icons.calendar_today,
              children: [
                _buildInfoRow(
                  context,
                  icon: Icons.shopping_cart,
                  label: 'Íµ¨Îß§Ïùº',
                  value: app_date_utils.DateUtils.formatKorean(food.purchaseDate),
                  subtitle: app_date_utils.DateUtils.formatRelative(food.purchaseDate),
                ),
                _buildInfoRow(
                  context,
                  icon: Icons.event_available,
                  label: 'Ïú†ÌÜµÍ∏∞Ìïú',
                  value: app_date_utils.DateUtils.formatKorean(food.expiryDate),
                  subtitle: app_date_utils.DateUtils.formatRelative(food.expiryDate),
                ),
                if (food.isConsumed && food.consumedDate != null)
                  _buildInfoRow(
                    context,
                    icon: Icons.check_circle,
                    label: 'ÏÜåÎπÑÏùº',
                    value: app_date_utils.DateUtils.formatKorean(food.consumedDate!),
                    subtitle: app_date_utils.DateUtils.formatTimeAgo(food.consumedDate!),
                  ),
                _buildInfoRow(
                  context,
                  icon: Icons.timer,
                  label: 'Î≥¥Í¥Ä Í∏∞Í∞Ñ',
                  value: '${app_date_utils.DateUtils.daysBetween(food.purchaseDate, food.expiryDate)}Ïùº',
                ),
              ],
            ),
            
            const SizedBox(height: 16),
            
            // ÏïåÎ¶º Ï†ïÎ≥¥ Ïπ¥Îìú
            if (!food.isConsumed) ...[
              _buildInfoCard(
                context,
                title: 'ÏïåÎ¶º Ï†ïÎ≥¥',
                icon: Icons.notifications_active,
                children: [
                  _buildInfoRow(
                    context,
                    icon: Icons.alarm,
                    label: 'ÏïåÎ¶º ÏãúÏ†ê',
                    value: AppConstants.notificationLabels[food.notificationDays] ??
                        'D-${food.notificationDays}',
                  ),
                  _buildInfoRow(
                    context,
                    icon: Icons.schedule,
                    label: 'ÏïåÎ¶º Î∞úÏÜ°Ïùº',
                    value: app_date_utils.DateUtils.formatKorean(food.notificationDate),
                    subtitle: app_date_utils.DateUtils.formatRelative(food.notificationDate),
                  ),
                ],
              ),
              const SizedBox(height: 16),
            ],
            
            // Îì±Î°ù Ï†ïÎ≥¥
            _buildInfoCard(
              context,
              title: 'Îì±Î°ù Ï†ïÎ≥¥',
              icon: Icons.info,
              children: [
                _buildInfoRow(
                  context,
                  icon: Icons.add_circle,
                  label: 'Îì±Î°ùÏùºÏãú',
                  value: app_date_utils.DateUtils.formatDateTime(food.createdAt),
                  subtitle: app_date_utils.DateUtils.formatTimeAgo(food.createdAt),
                ),
                _buildInfoRow(
                  context,
                  icon: Icons.fingerprint,
                  label: 'ID',
                  value: food.id.substring(0, 8),
                ),
              ],
            ),
            
            const SizedBox(height: 32),
            
            // Ïï°ÏÖò Î≤ÑÌäº
            if (!food.isConsumed) ...[
              ElevatedButton.icon(
                onPressed: () => _markAsConsumed(context),
                icon: const Icon(Icons.check),
                label: const Text('ÏÜåÎπÑ ÏôÑÎ£åÎ°ú ÌëúÏãú'),
                style: ElevatedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  backgroundColor: AppConstants.freshGreen,
                ),
              ),
            ] else ...[
              OutlinedButton.icon(
                onPressed: () => _markAsUnconsumed(context),
                icon: const Icon(Icons.undo),
                label: const Text('Îã§Ïãú Î≥¥Í¥Ä Ï§ëÏúºÎ°ú Î≥ÄÍ≤Ω'),
                style: OutlinedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 16),
                ),
              ),
            ],
            
            const SizedBox(height: 16),
            
            // ÏÇ≠Ï†ú Î≤ÑÌäº
            OutlinedButton.icon(
              onPressed: () => _showDeleteDialog(context),
              icon: const Icon(Icons.delete, color: AppConstants.dangerRed),
              label: const Text(
                'ÏÇ≠Ï†ú',
                style: TextStyle(color: AppConstants.dangerRed),
              ),
              style: OutlinedButton.styleFrom(
                padding: const EdgeInsets.symmetric(vertical: 16),
                side: const BorderSide(color: AppConstants.dangerRed),
              ),
            ),
          ],
        ),
      ),
    );
  }

  /// Ï†ïÎ≥¥ Ïπ¥Îìú ÏúÑÏ†Ø
  Widget _buildInfoCard(
    BuildContext context, {
    required String title,
    required IconData icon,
    required List<Widget> children,
  }) {
    return Card(
      elevation: 2,
      child: Padding(
        padding: const EdgeInsets.all(AppConstants.defaultPadding),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(icon, color: AppConstants.freshGreen, size: 20),
                const SizedBox(width: 8),
                Text(
                  title,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            ...children,
          ],
        ),
      ),
    );
  }

  /// Ï†ïÎ≥¥ Ìñâ ÏúÑÏ†Ø
  Widget _buildInfoRow(
    BuildContext context, {
    required IconData icon,
    required String label,
    required String value,
    String? subtitle,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, size: 20, color: Colors.grey[600]),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: Colors.grey[600],
                      ),
                ),
                const SizedBox(height: 4),
                Text(
                  value,
                  style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                        fontWeight: FontWeight.w500,
                      ),
                ),
                if (subtitle != null) ...[
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: AppConstants.freshGreen,
                          fontWeight: FontWeight.w500,
                        ),
                  ),
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// ÏÜåÎπÑ ÏôÑÎ£åÎ°ú ÌëúÏãú
  Future<void> _markAsConsumed(BuildContext context) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÏÜåÎπÑ ÏôÑÎ£å'),
        content: Text('${food.name}ÏùÑ(Î•º) ÏÜåÎπÑ ÏôÑÎ£åÎ°ú ÌëúÏãúÌïòÏãúÍ≤†ÏäµÎãàÍπå?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Ï∑®ÏÜå'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('ÌôïÏù∏'),
          ),
        ],
      ),
    );

    if (confirmed == true && context.mounted) {
      await context.read<FoodProvider>().markAsConsumed(food.id);
      if (context.mounted) {
        Navigator.pop(context, true);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('ÏÜåÎπÑ ÏôÑÎ£åÎ°ú ÌëúÏãúÎêòÏóàÏäµÎãàÎã§'),
            backgroundColor: AppConstants.freshGreen,
          ),
        );
      }
    }
  }

  /// Îã§Ïãú Î≥¥Í¥Ä Ï§ëÏúºÎ°ú Î≥ÄÍ≤Ω
  Future<void> _markAsUnconsumed(BuildContext context) async {
    await context.read<FoodProvider>().markAsUnconsumed(food.id);
    if (context.mounted) {
      Navigator.pop(context, true);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Îã§Ïãú Î≥¥Í¥Ä Ï§ëÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§'),
          backgroundColor: AppConstants.freshGreen,
        ),
      );
    }
  }

  /// ÏÇ≠Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏
  Future<void> _showDeleteDialog(BuildContext context) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text(AppConstants.deleteConfirmTitle),
        content: Text('${food.name}ÏùÑ(Î•º) ${AppConstants.deleteConfirmMessage}'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Ï∑®ÏÜå'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            style: TextButton.styleFrom(
              foregroundColor: AppConstants.dangerRed,
            ),
            child: const Text('ÏÇ≠Ï†ú'),
          ),
        ],
      ),
    );

    if (confirmed == true && context.mounted) {
      await context.read<FoodProvider>().deleteFood(food.id);
      if (context.mounted) {
        Navigator.pop(context, true);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(AppConstants.deleteSuccess),
          ),
        );
      }
    }
  }
}

